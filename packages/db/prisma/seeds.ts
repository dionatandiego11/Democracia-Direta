import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Iniciando seed do banco de dados...');

  // Limpar dados existentes (opcional)
  await prisma.auditLog.deleteMany();
  await prisma.vote.deleteMany();
  await prisma.voteSession.deleteMany();
  await prisma.comment.deleteMany();
  await prisma.reviewVote.deleteMany();
  await prisma.pullRequest.deleteMany();
  await prisma.issue.deleteMany();
  await prisma.proposalVersion.deleteMany();
  await prisma.proposalLabel.deleteMany();
  await prisma.label.deleteMany();
  await prisma.proposal.deleteMany();
  await prisma.membership.deleteMany();
  await prisma.user.deleteMany();
  await prisma.orgUnit.deleteMany();

  // 1. Criar Unidades Organizacionais
  console.log('üìç Criando unidades organizacionais...');
  
  const nacional = await prisma.orgUnit.create({
    data: {
      name: 'Diret√≥rio Nacional',
      slug: 'nacional',
      level: 'NATIONAL',
      code: 'BR'
    }
  });

  const sp = await prisma.orgUnit.create({
    data: {
      name: 'Diret√≥rio Estadual SP',
      slug: 'sp',
      level: 'STATE',
      code: 'SP',
      parentId: nacional.id
    }
  });

  const rj = await prisma.orgUnit.create({
    data: {
      name: 'Diret√≥rio Estadual RJ',
      slug: 'rj',
      level: 'STATE',
      code: 'RJ',
      parentId: nacional.id
    }
  });

  const spCapital = await prisma.orgUnit.create({
    data: {
      name: 'Diret√≥rio Municipal SP Capital',
      slug: 'sp-capital',
      level: 'MUNICIPAL',
      code: 'SP-SAO-PAULO',
      parentId: sp.id
    }
  });

  const tematico = await prisma.orgUnit.create({
    data: {
      name: 'N√∫cleo Tem√°tico - Meio Ambiente',
      slug: 'meio-ambiente',
      level: 'THEMATIC',
      code: 'THEME-ENV',
      parentId: nacional.id
    }
  });

  // 2. Criar Usu√°rios
  console.log('üë• Criando usu√°rios...');
  
  const admin = await prisma.user.create({
    data: {
      email: 'admin@partido.br',
      name: 'Administrador Nacional',
      documentId: 'admin-hash-123'
    }
  });

  const coordSP = await prisma.user.create({
    data: {
      email: 'coord.sp@partido.br',
      name: 'Coordenador SP'
    }
  });

  const coordRJ = await prisma.user.create({
    data: {
      email: 'coord.rj@partido.br',
      name: 'Coordenadora RJ'
    }
  });

  const filiado1 = await prisma.user.create({
    data: {
      email: 'ana.silva@partido.br',
      name: 'Ana Silva'
    }
  });

  const filiado2 = await prisma.user.create({
    data: {
      email: 'joao.santos@partido.br',
      name: 'Jo√£o Santos'
    }
  });

  const filiado3 = await prisma.user.create({
    data: {
      email: 'maria.costa@partido.br',
      name: 'Maria Costa'
    }
  });

  // 3. Criar Memberships
  console.log('üîó Criando associa√ß√µes...');
  
  await prisma.membership.createMany({
    data: [
      {
        userId: admin.id,
        orgUnitId: nacional.id,
        role: 'EXECUTIVO_NACIONAL',
        active: true
      },
      {
        userId: coordSP.id,
        orgUnitId: sp.id,
        role: 'COORDENADOR',
        active: true
      },
      {
        userId: coordRJ.id,
        orgUnitId: rj.id,
        role: 'COORDENADOR',
        active: true
      },
      {
        userId: filiado1.id,
        orgUnitId: sp.id,
        role: 'FILIADO',
        active: true
      },
      {
        userId: filiado2.id,
        orgUnitId: spCapital.id,
        role: 'FILIADO',
        active: true
      },
      {
        userId: filiado3.id,
        orgUnitId: tematico.id,
        role: 'FILIADO',
        active: true
      }
    ]
  });

  // 4. Criar Labels
  console.log('üè∑Ô∏è Criando labels...');
  
  const labels = await prisma.label.createMany({
    data: [
      { name: 'bug', color: '#d73a4a', orgUnitId: nacional.id },
      { name: 'enhancement', color: '#a2eeef', orgUnitId: nacional.id },
      { name: 'documentation', color: '#0075ca', orgUnitId: nacional.id },
      { name: 'urgente', color: '#ff0000', orgUnitId: nacional.id },
      { name: 'consenso', color: '#00ff00', orgUnitId: nacional.id }
    ]
  });

  // 5. Criar Propostas
  console.log('üìù Criando propostas...');
  
  const proposta1 = await prisma.proposal.create({
    data: {
      title: 'Reforma do Estatuto - Cap√≠tulo 3',
      slug: 'reforma-estatuto-cap3',
      orgUnitId: nacional.id,
      authorId: admin.id,
      status: 'OPEN',
      versions: {
        create: {
          version: 1,
          contentMd: `# Reforma do Estatuto - Cap√≠tulo 3

## Artigo 3¬∫ - Dos Direitos dos Filiados

Todo filiado tem direito a:
- Participar de decis√µes internas atrav√©s de propostas e vota√ß√µes
- Votar em todas as consultas de sua unidade organizacional
- Apresentar propostas e emendas aos documentos do partido
- Delegar seu voto quando impossibilitado de participar
- Acesso transparente a todas as decis√µes e documentos

## Artigo 4¬∫ - Dos Deveres

S√£o deveres do filiado:
- Respeitar o estatuto e c√≥digo de conduta da organiza√ß√£o
- Contribuir ativamente com a organiza√ß√£o e suas propostas
- Participar das delibera√ß√µes sempre que poss√≠vel
- Manter suas informa√ß√µes de cadastro atualizadas
- Zelar pela democracia interna e transpar√™ncia`,
          createdById: admin.id
        }
      }
    }
  });

  const proposta2 = await prisma.proposal.create({
    data: {
      title: 'Programa de Mobilidade Urbana Sustent√°vel',
      slug: 'mobilidade-urbana-sp',
      orgUnitId: sp.id,
      authorId: coordSP.id,
      status: 'OPEN',
      versions: {
        create: {
          version: 1,
          contentMd: `# Programa de Mobilidade Urbana Sustent√°vel

## Objetivo
Propor diretrizes para mobilidade urbana sustent√°vel no estado de S√£o Paulo.

## Diretrizes

### 1. Transporte P√∫blico
- Expans√£o do metr√¥ e trem metropolitano
- Integra√ß√£o tarif√°ria entre modais
- Corredores de √¥nibus el√©tricos

### 2. Mobilidade Ativa
- Ciclovias seguras e integradas
- Cal√ßadas acess√≠veis
- Zonas de baixa velocidade em √°reas residenciais

### 3. Tecnologia
- App unificado de mobilidade
- Pagamento digital integrado
- Dados abertos de transporte`,
          createdById: coordSP.id
        }
      }
    }
  });

  const proposta3 = await prisma.proposal.create({
    data: {
      title: 'Pol√≠tica de Prote√ß√£o Ambiental',
      slug: 'protecao-ambiental',
      orgUnitId: tematico.id,
      authorId: filiado3.id,
      status: 'DRAFT',
      versions: {
        create: {
          version: 1,
          contentMd: `# Pol√≠tica de Prote√ß√£o Ambiental

## Contexto
Proposta de diretrizes para prote√ß√£o ambiental em n√≠vel nacional.

## Eixos Principais

1. **Preserva√ß√£o de Biomas**
2. **Economia Circular**
3. **Energias Renov√°veis**
4. **Educa√ß√£o Ambiental**

*(Documento em elabora√ß√£o)*`,
          createdById: filiado3.id
        }
      }
    }
  });

  // 6. Criar Issues
  console.log('üêõ Criando issues...');
  
  const issue1 = await prisma.issue.create({
    data: {
      proposalId: proposta1.id,
      authorId: filiado1.id,
      title: 'Definir crit√©rios para delega√ß√£o de voto',
      body: 'Precisamos especificar melhor os crit√©rios e limites para delega√ß√£o de voto entre filiados.',
      status: 'OPEN'
    }
  });

  const issue2 = await prisma.issue.create({
    data: {
      proposalId: proposta2.id,
      authorId: filiado2.id,
      title: 'Adicionar se√ß√£o sobre transporte ferrovi√°rio',
      body: 'Sugiro incluir diretrizes espec√≠ficas sobre expans√£o ferrovi√°ria para cidades m√©dias.',
      status: 'OPEN'
    }
  });

  // 7. Criar Coment√°rios
  console.log('üí¨ Criando coment√°rios...');
  
  await prisma.comment.createMany({
    data: [
      {
        issueId: issue1.id,
        authorId: coordSP.id,
        body: 'Concordo! Sugiro limitarmos delega√ß√µes a no m√°ximo 3 votos por pessoa.'
      },
      {
        issueId: issue1.id,
        authorId: admin.id,
        body: 'Boa sugest√£o. Vou abrir um PR com essa altera√ß√£o.'
      },
      {
        issueId: issue2.id,
        authorId: coordSP.id,
        body: 'Excelente ponto. Vou incorporar isso na pr√≥xima vers√£o.'
      }
    ]
  });

  // 8. Criar Pull Request
  console.log('üîÄ Criando pull requests...');
  
  const pr1 = await prisma.pullRequest.create({
    data: {
      fromProposalId: proposta2.id,
      toProposalId: proposta1.id,
      title: 'Adiciona refer√™ncia cruzada ao programa de mobilidade',
      description: 'Este PR adiciona uma refer√™ncia ao programa de mobilidade urbana no estatuto.',
      status: 'OPEN',
      createdById: coordSP.id
    }
  });

  // 9. Criar Reviews
  console.log('‚≠ê Criando reviews...');
  
  await prisma.reviewVote.createMany({
    data: [
      {
        prId: pr1.id,
        userId: admin.id,
        value: 'LIKE',
        reason: '√ìtima integra√ß√£o entre os documentos!'
      },
      {
        prId: pr1.id,
        userId: filiado1.id,
        value: 'LIKE',
        reason: 'Apoio totalmente esta mudan√ßa.'
      }
    ]
  });

  // 10. Criar Sess√µes de Vota√ß√£o
  console.log('üó≥Ô∏è Criando sess√µes de vota√ß√£o...');
  
  const now = new Date();
  const in7Days = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
  const in14Days = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);

  const sessao1 = await prisma.voteSession.create({
    data: {
      orgUnitId: nacional.id,
      title: 'Aprova√ß√£o do Or√ßamento 2025',
      scope: 'PROPOSAL',
      subjectId: proposta1.id,
      rule: 'ONE_MEMBER_ONE_VOTE',
      round: 'FIRST_READING',
      startsAt: now,
      endsAt: in7Days,
      createdById: admin.id,
      quorum: 50,
      threshold: 60
    }
  });

  const sessao2 = await prisma.voteSession.create({
    data: {
      orgUnitId: sp.id,
      title: 'Programa de Mobilidade - Primeira Leitura',
      scope: 'PROPOSAL',
      subjectId: proposta2.id,
      rule: 'WEIGHT_BY_ROLE',
      round: 'FIRST_READING',
      startsAt: now,
      endsAt: in14Days,
      createdById: coordSP.id,
      quorum: 40,
      threshold: 50
    }
  });

  // 11. Criar Votos
  console.log('‚úÖ Criando votos...');
  
  await prisma.vote.createMany({
    data: [
      {
        sessionId: sessao1.id,
        userId: admin.id,
        choice: 'YES',
        weight: 1,
        justification: 'Aprovado pela diretoria executiva.'
      },
      {
        sessionId: sessao1.id,
        userId: coordSP.id,
        choice: 'YES',
        weight: 1,
        justification: 'Apoio integral ao or√ßamento proposto.'
      },
      {
        sessionId: sessao1.id,
        userId: filiado1.id,
        choice: 'YES',
        weight: 1
      },
      {
        sessionId: sessao2.id,
        userId: coordSP.id,
        choice: 'YES',
        weight: 2,
        justification: 'Como autor, defendo esta proposta.'
      },
      {
        sessionId: sessao2.id,
        userId: filiado1.id,
        choice: 'YES',
        weight: 1
      },
      {
        sessionId: sessao2.id,
        userId: filiado2.id,
        choice: 'ABSTAIN',
        weight: 1,
        justification: 'Preciso estudar melhor o impacto financeiro.'
      }
    ]
  });

  // 12. Criar Audit Logs
  console.log('üìã Criando audit logs...');
  
  await prisma.auditLog.createMany({
    data: [
      {
        actorId: admin.id,
        action: 'CREATE_PROPOSAL',
        target: `Proposal:${proposta1.id}`,
        metadata: { title: proposta1.title }
      },
      {
        actorId: coordSP.id,
        action: 'CREATE_PROPOSAL',
        target: `Proposal:${proposta2.id}`,
        metadata: { title: proposta2.title }
      },
      {
        actorId: admin.id,
        action: 'CREATE_VOTE_SESSION',
        target: `VoteSession:${sessao1.id}`,
        metadata: { title: sessao1.title }
      },
      {
        actorId: coordSP.id,
        action: 'CREATE_PULL_REQUEST',
        target: `PullRequest:${pr1.id}`,
        metadata: { title: pr1.title }
      }
    ]
  });

  // 13. Criar Reputa√ß√µes
  console.log('üèÜ Criando reputa√ß√µes...');
  
  await prisma.userReputation.createMany({
    data: [
      {
        userId: admin.id,
        points: 890,
        proposalsCreated: 23,
        votesParticipated: 156,
        commentsPosted: 87,
        consensusBuilt: 12
      },
      {
        userId: coordSP.id,
        points: 745,
        proposalsCreated: 18,
        votesParticipated: 142,
        commentsPosted: 65,
        consensusBuilt: 9
      },
      {
        userId: filiado1.id,
        points: 680,
        proposalsCreated: 15,
        votesParticipated: 138,
        commentsPosted: 92,
        consensusBuilt: 7
      }
    ]
  });

  console.log('');
  console.log('‚úÖ Seed completo com sucesso!');
  console.log('');
  console.log('üìä Resumo:');
  console.log(`- ${await prisma.orgUnit.count()} unidades organizacionais`);
  console.log(`- ${await prisma.user.count()} usu√°rios`);
  console.log(`- ${await prisma.proposal.count()} propostas`);
  console.log(`- ${await prisma.issue.count()} issues`);
  console.log(`- ${await prisma.pullRequest.count()} pull requests`);
  console.log(`- ${await prisma.voteSession.count()} sess√µes de vota√ß√£o`);
  console.log(`- ${await prisma.vote.count()} votos registrados`);
  console.log('');
  console.log('üë§ Usu√°rios de teste:');
  console.log('- admin@partido.br (Executivo Nacional)');
  console.log('- coord.sp@partido.br (Coordenador SP)');
  console.log('- coord.rj@partido.br (Coordenadora RJ)');
  console.log('- ana.silva@partido.br (Filiada SP)');
  console.log('- joao.santos@partido.br (Filiado SP Capital)');
  console.log('- maria.costa@partido.br (Filiada N√∫cleo Ambiental)');
  console.log('');
  console.log('üöÄ Sistema pronto para uso!');
}

main()
  .catch((e) => {
    console.error('‚ùå Erro durante seed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });